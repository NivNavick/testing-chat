# Medical Insights Workflow (Combined)
# 
# A unified workflow that processes multiple file types and runs
# all applicable insight blocks in parallel branches.
#
# Architecture:
#   upload ‚Üí preprocess ‚Üí classify ‚îÄ‚î¨‚îÄ‚ñ∫ staff_timing ‚îÄ‚îÄ‚ñ∫ export_staff_timing ‚îÄ‚îê
#                                   ‚îú‚îÄ‚ñ∫ expensive_employees ‚îÄ‚îÄ‚ñ∫ export_salary ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
#                                   ‚îú‚îÄ‚ñ∫ manpower_cost ‚îÄ‚îÄ‚ñ∫ export_manpower_cost ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚ñ∫ email_all_reports
#                                   ‚îî‚îÄ‚ñ∫ gross_profit ‚îÄ‚îÄ‚ñ∫ export_gross_profit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
#
# Key Features:
# - Single classification step handles ALL input files
# - Each insight block picks only the doc types it needs
# - Missing doc types cause graceful skip (not failure)
# - Each insight has its own export block with unique output
# - All reports sent via email (AWS SES) in a single message with attachments
#
# Insights:
# 1. staff_timing: Unified timing validation (needs: shift_schedule, employee_shifts, medical_actions)
#    - Role counts (1 recovery nurse per shift, gastro nurses >= concurrent doctors)
#    - Early arrival detection (arrived too early before first procedure)
#    - Early departure detection (left before coverage period ended)
# 2. expensive_employees: Rank employees by cost (needs: employee_monthly_salary)
# 3. manpower_cost: Shift costs + avg cost per procedure (needs: employee_shifts, employee_compensation)
# 4. gross_profit: Revenue - physician cost - staff cost (needs: employee_shifts, employee_compensation, medical_actions)
#
# Usage:
#   # Run with shifts + actions + compensation (all financial insights run)
#   python -m csv_analyzer.run_workflow medical_insights \
#       --files shifts.csv actions.csv compensation.csv --local
#
#   # Run with salary data (salary analysis will run, others will skip)
#   python -m csv_analyzer.run_workflow medical_insights \
#       --files monthly_salary.csv --local
#
#   # Run with ALL file types (all insights run)
#   python -m csv_analyzer.run_workflow medical_insights \
#       --files shifts.csv actions.csv monthly_salary.csv compensation.csv --local

name: medical_insights
description: "Combined medical insights - processes all file types, runs applicable analyses"
version: "1.0"

# Global parameters (accessible by all blocks)
parameters:
  vertical: medical
  output_dir: ./results
  # Email settings (niv@bubblez.ai must be verified in AWS SES)
  sender_email: niv@bubblez.ai
  recipient_email: nnavick@gmail.com
  # Expensive employees parameters
  top_n: 10
  include_all: true
  group_by_position: true
  # Manpower cost / gross profit parameters
  default_shift_hours: 8.0
  benefits_loading: 0.25
  # Staff timing parameters
  shift_time_boundary: "13:00"
  morning_shift_start: "06:00"
  evening_shift_end: "21:00"
  # Timing rules per role (configurable)
  # Each role can have: min_count, max_count, scope, arrival_buffer_minutes, departure_buffer_minutes, match_to
  # Timing rules per role:
  # - departure_buffer_minutes: Minimum time to stay after last procedure (0 = can leave immediately)
  # - departure_max_minutes: Maximum time allowed after last procedure (null = no limit)
  timing_rules:
    ◊ê◊ó ◊î◊™◊ê◊ï◊©◊©◊ï◊™:
      min_count: 1
      max_count: 1
      scope: per_shift
      arrival_buffer_minutes: 30
      departure_buffer_minutes: 0    # Can leave when last procedure ends
      departure_max_minutes: 60      # Must leave within 1 hour after last procedure
      match_to: all_procedures
    ◊ê◊ó ◊î◊™◊ê◊ï◊©◊©◊ï◊™ ◊¢◊®◊ë:
      min_count: 1
      max_count: 1
      scope: per_shift
      arrival_buffer_minutes: 30
      departure_buffer_minutes: 0
      departure_max_minutes: 60
      match_to: all_procedures
    ◊ê◊ó ◊í◊°◊ò◊®◊ï:
      min_count: 1
      max_count: null
      scope: per_concurrent_doctor
      arrival_buffer_minutes: 15
      departure_buffer_minutes: 0
      match_to: gastro_procedures
    ◊õ◊¢ ◊¢◊ñ◊®:
      min_count: 1
      scope: per_shift
      arrival_buffer_minutes: 30
      departure_buffer_minutes: 30
      match_to: all_procedures
    ◊õ◊¢ ◊¢◊ñ◊® ◊¢◊®◊ë:
      min_count: 1
      scope: per_shift
      arrival_buffer_minutes: 30
      departure_buffer_minutes: 30
      match_to: all_procedures
    ◊õ◊ó ◊¢◊ñ◊®:
      min_count: 1
      scope: per_shift
      arrival_buffer_minutes: 30
      departure_buffer_minutes: 30
      match_to: all_procedures

# Storage configuration
storage:
  type: s3
  bucket: ""  # Set via S3_BUCKET env var or --bucket CLI arg

blocks:
  # ============================================================
  # SHARED PIPELINE: Upload ‚Üí Preprocess ‚Üí Classify
  # ============================================================
  
  # Entry point - upload files to S3 (or local storage)
  - id: upload
    handler: upload_to_s3
    parameters:
      skip_upload: true  # Local mode - skip S3 upload

  # Preprocessing - transforms raw CSVs, adds _meta columns
  - id: preprocess
    handler: preprocess_csvs
    inputs:
      - name: files
        source: upload.uploaded_files
    parameters:
      detect_time_ranges: true
      detect_hebrew_dates: true
      clean_time_prefixes: true

  # Classification - canonizes ALL files to their doc types
  # Outputs: employee_shifts, medical_actions, employee_monthly_salary, etc.
  - id: classify
    handler: classify_csvs
    inputs:
      - name: files
        source: preprocess.processed_files
    parameters:
      vertical: "{{vertical}}"
      threshold: 0.5

  # ============================================================
  # BRANCH 1: Staff Timing Validation (Unified)
  # Requires: shift_schedule + employee_shifts + medical_actions (optional)
  # Validates: role counts, early arrival, early departure
  # ============================================================
  
  - id: staff_timing
    handler: staff_timing_validation
    inputs:
      - name: data
        source: classify.classified_data
    parameters:
      timing_rules: "{{timing_rules}}"
      shift_time_boundary: "{{shift_time_boundary}}"
      morning_shift_start: "{{morning_shift_start}}"
      evening_shift_end: "{{evening_shift_end}}"

  - id: export_staff_timing
    handler: export_csv
    inputs:
      - field: date
        source: staff_timing.result.date
      - field: shift_type
        source: staff_timing.result.shift_type
      - field: role
        source: staff_timing.result.role
      - field: validation_type
        source: staff_timing.result.validation_type
      - field: expected_count
        source: staff_timing.result.expected_count
      - field: actual_count
        source: staff_timing.result.actual_count
      - field: status
        source: staff_timing.result.status
      - field: employees_expected
        source: staff_timing.result.employees_expected
      - field: employees_arrived
        source: staff_timing.result.employees_arrived
      - field: doctor_name
        source: staff_timing.result.doctor_name
      - field: evidence
        source: staff_timing.result.evidence
    parameters:
      filename: "staff_timing_report.csv"
      output_dir: "{{output_dir}}"
      unique_name: true
      include_source_column: false

  # ============================================================
  # BRANCH 2: Expensive Employees Analysis
  # Requires: employee_monthly_salary
  # ============================================================
  
  - id: expensive_employees
    handler: expensive_employees
    inputs:
      - name: data
        source: classify.classified_data
    parameters:
      top_n: "{{top_n}}"
      include_all: "{{include_all}}"
      group_by_position: "{{group_by_position}}"

  - id: export_salary
    handler: export_csv
    inputs:
      - field: cost_rank
        source: expensive_employees.result.cost_rank
      - field: employee_name
        source: expensive_employees.result.employee_name
      - field: position
        source: expensive_employees.result.position
      - field: city
        source: expensive_employees.result.city
      - field: total_salary
        source: expensive_employees.result.total_salary
      - field: avg_monthly_salary
        source: expensive_employees.result.avg_monthly_salary
      - field: months_active
        source: expensive_employees.result.months_active
      - field: rate_primary
        source: expensive_employees.result.rate_primary
      - field: rate_secondary
        source: expensive_employees.result.rate_secondary
      - field: has_dual_rate
        source: expensive_employees.result.has_dual_rate
      - field: cost_percentile
        source: expensive_employees.result.cost_percentile
    parameters:
      filename: "expensive_employees_report.csv"
      output_dir: "{{output_dir}}"
      unique_name: true
      include_source_column: false

  # ============================================================
  # BRANCH 3: Manpower Cost Analysis
  # Requires: employee_shifts + employee_monthly_salary + medical_actions (optional)
  # ============================================================
  
  - id: manpower_cost
    handler: manpower_cost_per_shift
    inputs:
      - name: data
        source: classify.classified_data
    parameters:
      default_shift_hours: "{{default_shift_hours}}"
      benefits_loading: "{{benefits_loading}}"

  - id: export_manpower_cost
    handler: export_csv
    inputs:
      - field: shift_date
        source: manpower_cost.result.shift_date
      - field: employee_id
        source: manpower_cost.result.employee_id
      - field: employee_name
        source: manpower_cost.result.employee_name
      - field: position
        source: manpower_cost.result.position
      - field: detected_shift_type
        source: manpower_cost.result.detected_shift_type
      - field: shift_start
        source: manpower_cost.result.shift_start
      - field: shift_end
        source: manpower_cost.result.shift_end
      - field: shift_hours
        source: manpower_cost.result.shift_hours
      - field: hourly_cost
        source: manpower_cost.result.hourly_cost
      - field: employment_type
        source: manpower_cost.result.employment_type
      - field: shift_cost
        source: manpower_cost.result.shift_cost
      - field: procedure_count
        source: manpower_cost.result.procedure_count
      - field: avg_cost_per_procedure
        source: manpower_cost.result.avg_cost_per_procedure
      - field: evidence
        source: manpower_cost.result.evidence
    parameters:
      filename: "manpower_cost_report.csv"
      output_dir: "{{output_dir}}"
      unique_name: true
      include_source_column: false

  # ============================================================
  # BRANCH 4: Gross Profit Analysis
  # Requires: employee_shifts + employee_compensation + medical_actions
  # ============================================================
  
  - id: gross_profit
    handler: gross_profit_per_shift
    inputs:
      - name: data
        source: classify.classified_data
    parameters:
      default_shift_hours: "{{default_shift_hours}}"
      benefits_loading: "{{benefits_loading}}"

  - id: export_gross_profit
    handler: export_csv
    inputs:
      - field: shift_date
        source: gross_profit.result.shift_date
      - field: employee_id
        source: gross_profit.result.employee_id
      - field: employee_name
        source: gross_profit.result.employee_name
      - field: position
        source: gross_profit.result.position
      - field: employment_type
        source: gross_profit.result.employment_type
      - field: detected_shift_type
        source: gross_profit.result.detected_shift_type
      - field: shift_hours
        source: gross_profit.result.shift_hours
      - field: shift_cost
        source: gross_profit.result.shift_cost
      - field: procedure_count
        source: gross_profit.result.procedure_count
      - field: total_revenue
        source: gross_profit.result.total_revenue
      - field: total_doctor_fee
        source: gross_profit.result.total_doctor_fee
      - field: gross_profit
        source: gross_profit.result.gross_profit
      - field: profit_margin_pct
        source: gross_profit.result.profit_margin_pct
      - field: procedure_details
        source: gross_profit.result.procedure_details
      - field: evidence
        source: gross_profit.result.evidence
    parameters:
      filename: "gross_profit_report.csv"
      output_dir: "{{output_dir}}"
      unique_name: true
      include_source_column: false

  # ============================================================
  # EMAIL ALL REPORTS
  # Sends all 4 reports in a single email with attachments
  # ============================================================
  
  - id: email_all_reports
    handler: send_email_ses
    inputs:
      - name: data
        sources:
          - staff_timing.result
          - expensive_employees.result
          - manpower_cost.result
          - gross_profit.result
    parameters:
      sender_email: "{{sender_email}}"
      recipient_email: "{{recipient_email}}"
      subject: "Medical Insights - Daily Reports Bundle"
      attachment_filename_prefix: "medical_report"
      body_text: |
        Hello,
        
        Please find attached the complete medical insights analysis:
        
        üë©‚Äç‚öïÔ∏è Report 1: Staff Timing Validation
           - Role count validation (1 recovery nurse per shift)
           - Early arrival detection (arrived too early before procedures)
           - Early departure detection (left before coverage ended)
           - Gastro nurse coverage vs concurrent doctors
           - Schedule attendance tracking
        
        üí∞ Report 2: Expensive Employees Ranking
           - Top employees by total compensation cost
           - Grouped by position with salary breakdowns
        
        üë• Report 3: Manpower Cost Analysis
           - Shift-by-shift cost breakdown
           - Average cost per medical procedure
        
        üìà Report 4: Gross Profit Analysis
           - Revenue vs. cost analysis per shift
           - Profit margins and procedure details
        
        Best regards,
        Automated Medical Insights System
      include_summary: true

