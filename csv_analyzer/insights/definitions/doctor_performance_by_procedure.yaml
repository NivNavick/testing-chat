# Insight: Doctor Performance by Procedure Type
# Identifies slow/fast performers by comparing each doctor's procedure time to department average

name: doctor_performance_by_procedure
version: "1.0"
description: "Analyzes doctor performance by procedure type, flagging slow performers compared to department average"
category: performance
tags:
  - performance
  - efficiency
  - doctors
  - procedures
  - benchmarking

requires:
  - staff_clinical_procedures
  - employee_compensation
  - employee_shifts

parameters:
  - name: start_date
    type: date
    required: false
    description: "Filter from this date"
  - name: end_date
    type: date
    required: false
    description: "Filter until this date"
  - name: department
    type: string
    required: false
    description: "Filter by department"
  - name: min_procedure_count
    type: integer
    required: false
    default: 2
    description: "Minimum procedures needed for comparison (default: 2)"

sql: |
  -- Step 1: Calculate shift workload and procedure duration per shift
  WITH shift_workload AS (
    SELECT 
      s.employee_id,
      s.shift_date,
      s.department_code,
      COALESCE(s.duration_minutes / 60.0, 8.0) AS shift_hours,
      COUNT(p.procedure_id) AS procedures_in_shift
    FROM employee_shifts s
    LEFT JOIN staff_clinical_procedures p 
      ON s.employee_id = p.staff_id 
      AND CAST(p.performed_datetime AS DATE) = s.shift_date
      AND CAST(p.performed_datetime AS TIME) BETWEEN CAST(s.shift_start AS TIME) AND CAST(s.shift_end AS TIME)
    WHERE 1=1
      {? AND s.shift_date >= '{{start_date}}' ?}
      {? AND s.shift_date <= '{{end_date}}' ?}
      {? AND s.department_code = '{{department}}' ?}
    GROUP BY s.employee_id, s.shift_date, s.department_code, s.duration_minutes
  ),
  -- Step 2: Calculate estimated hours per procedure for each shift
  shift_durations AS (
    SELECT 
      *,
      CASE 
        WHEN procedures_in_shift > 0 THEN shift_hours / procedures_in_shift
        ELSE NULL
      END AS estimated_hours_per_procedure
    FROM shift_workload
  ),
  -- Step 3: Join procedures with durations and compensation
  procedure_durations AS (
    SELECT 
      p.procedure_id,
      p.billing_code,
      p.procedure_description,
      p.staff_id AS employee_id,
      p.performed_datetime,
      p.location AS department,
      sd.estimated_hours_per_procedure,
      c.employee_name,
      c.position,
      c.employment_type,
      COALESCE(c.effective_hourly_cost, c.hourly_rate, 0) AS hourly_cost
    FROM staff_clinical_procedures p
    LEFT JOIN shift_durations sd 
      ON p.staff_id = sd.employee_id 
      AND CAST(p.performed_datetime AS DATE) = sd.shift_date
    LEFT JOIN employee_compensation c 
      ON p.staff_id = c.employee_id
    WHERE sd.estimated_hours_per_procedure IS NOT NULL
      AND c.position IS NOT NULL
      {? AND CAST(p.performed_datetime AS DATE) >= '{{start_date}}' ?}
      {? AND CAST(p.performed_datetime AS DATE) <= '{{end_date}}' ?}
      {? AND p.location = '{{department}}' ?}
  ),
  -- Step 4: Calculate per-doctor averages for each procedure type
  doctor_stats AS (
    SELECT 
      employee_id,
      MAX(employee_name) AS employee_name,
      MAX(position) AS position,
      MAX(employment_type) AS employment_type,
      billing_code,
      MAX(procedure_description) AS procedure_description,
      COUNT(*) AS procedures_performed,
      ROUND(AVG(estimated_hours_per_procedure), 2) AS avg_duration_hours,
      ROUND(AVG(hourly_cost), 2) AS avg_hourly_cost,
      ROUND(AVG(estimated_hours_per_procedure * hourly_cost), 2) AS avg_cost_per_procedure,
      ROUND(SUM(estimated_hours_per_procedure * hourly_cost), 2) AS total_cost
    FROM procedure_durations
    GROUP BY employee_id, billing_code
    HAVING COUNT(*) >= {{min_procedure_count}}
  ),
  -- Step 5: Calculate department averages for each procedure type
  department_avg AS (
    SELECT 
      billing_code,
      ROUND(AVG(estimated_hours_per_procedure), 2) AS dept_avg_duration_hours,
      COUNT(DISTINCT employee_id) AS doctors_performing
    FROM procedure_durations
    GROUP BY billing_code
  )
  -- Step 6: Compare doctor performance to department average
  SELECT 
    ds.employee_id,
    ds.employee_name,
    ds.position,
    ds.employment_type,
    ds.billing_code,
    ds.procedure_description,
    ds.procedures_performed,
    ds.avg_duration_hours,
    da.dept_avg_duration_hours,
    da.doctors_performing,
    -- Calculate variance percentage
    ROUND(((ds.avg_duration_hours - da.dept_avg_duration_hours) / da.dept_avg_duration_hours) * 100, 1) AS duration_variance_pct,
    -- Performance flag
    CASE 
      WHEN ds.avg_duration_hours > da.dept_avg_duration_hours * 1.5 THEN 'VERY_SLOW'
      WHEN ds.avg_duration_hours > da.dept_avg_duration_hours * 1.2 THEN 'SLOW'
      WHEN ds.avg_duration_hours < da.dept_avg_duration_hours * 0.9 THEN 'FAST'
      ELSE 'AVERAGE'
    END AS performance_flag,
    ds.avg_hourly_cost,
    ds.avg_cost_per_procedure,
    ds.total_cost,
    -- EVIDENCE: Detailed performance comparison
    ds.employee_name || ' (' || ds.employee_id || ', ' || ds.position || ') ' ||
    'performed ' || ds.procedures_performed || ' × ' || ds.billing_code || ' (' || ds.procedure_description || '). ' ||
    'Avg time: ' || ds.avg_duration_hours || 'h per procedure. ' ||
    'Department avg: ' || da.dept_avg_duration_hours || 'h (' || da.doctors_performing || ' doctor(s)). ' ||
    CASE 
      WHEN ds.avg_duration_hours > da.dept_avg_duration_hours THEN
        'Performance: ' || ROUND(((ds.avg_duration_hours - da.dept_avg_duration_hours) / da.dept_avg_duration_hours) * 100, 1) || '% SLOWER than average. '
      WHEN ds.avg_duration_hours < da.dept_avg_duration_hours THEN
        'Performance: ' || ABS(ROUND(((ds.avg_duration_hours - da.dept_avg_duration_hours) / da.dept_avg_duration_hours) * 100, 1)) || '% FASTER than average. '
      ELSE 
        'Performance: ON PAR with department average. '
    END ||
    'Avg cost: $' || ds.avg_cost_per_procedure || '/procedure. ' ||
    'Total cost for this procedure type: $' || ds.total_cost || '. ' ||
    CASE 
      WHEN ds.avg_duration_hours > da.dept_avg_duration_hours * 1.5 THEN 
        '⚠️ VERY SLOW - Consider training or workload review.'
      WHEN ds.avg_duration_hours > da.dept_avg_duration_hours * 1.2 THEN 
        '⚠️ SLOW - May need efficiency improvement.'
      WHEN ds.avg_duration_hours < da.dept_avg_duration_hours * 0.9 THEN 
        '✓ FAST - High efficiency, potential best practice.'
      ELSE 
        '✓ AVERAGE - Within normal range.'
    END AS evidence
  FROM doctor_stats ds
  INNER JOIN department_avg da 
    ON ds.billing_code = da.billing_code
  ORDER BY 
    -- Show slow performers first
    CASE 
      WHEN ds.avg_duration_hours > da.dept_avg_duration_hours * 1.5 THEN 0
      WHEN ds.avg_duration_hours > da.dept_avg_duration_hours * 1.2 THEN 1
      WHEN ds.avg_duration_hours < da.dept_avg_duration_hours * 0.9 THEN 2
      ELSE 3
    END,
    ds.billing_code,
    ds.procedures_performed DESC

