# Manpower Cost per Shift using DuckDB SQL
# Migrated from ManpowerCostBlock (Python pandas) to pure SQL
#
# Calculates:
# - Shift cost = shift_hours × hourly_rate
# - Procedure count per shift (matched by time window)
# - Average cost per procedure

name: manpower_cost
display_name: "Manpower Cost per Shift"
description: "Calculate manpower cost for each shift, including average cost per procedure"
version: "1.0"
category: costs
type: SQL

tags:
  - costs
  - manpower
  - shifts
  - procedures

# Required document types
requires:
  - employee_shifts

# Optional tables (one compensation source required)
optional_tables:
  - employee_compensation
  - employee_monthly_salary
  - medical_actions

# Output columns
output_columns:
  - shift_date
  - employee_id
  - employee_name
  - position
  - shift_start
  - shift_end
  - shift_hours
  - hourly_cost
  - employment_type
  - shift_cost
  - procedure_count
  - avg_cost_per_procedure
  - detected_shift_type
  - evidence

# Configurable parameters
parameters:
  - name: default_shift_hours
    type: float
    default: 8.0
    description: "Default shift hours when duration cannot be calculated"
  - name: benefits_loading
    type: float
    default: 0.25
    description: "Benefits loading factor for salaried employees (0.25 = 25%)"
  - name: default_monthly_hours
    type: float
    default: 186.0
    description: "Default monthly hours for salary to hourly conversion"

sql: |
  -- Manpower Cost per Shift using DuckDB SQL
  
  WITH 
  -- Step 1: Prepare shift data with parsed times and duration
  shifts_prepared AS (
    SELECT 
      COALESCE(employee_id, _meta_employee_id, '') AS employee_id,
      COALESCE(employee_name, _meta_employee_name, '') AS employee_name,
      COALESCE(shift_date, _meta_date_range_start) AS shift_date,
      shift_start,
      shift_end,
      -- Parse times
      TRY_CAST(
        TRIM(REPLACE(REPLACE(CAST(shift_start AS VARCHAR), '*', ''), ' ', ''))
        AS TIME
      ) AS shift_start_parsed,
      TRY_CAST(
        TRIM(REPLACE(REPLACE(CAST(shift_end AS VARCHAR), '*', ''), ' ', ''))
        AS TIME
      ) AS shift_end_parsed,
      -- Calculate duration
      CASE 
        WHEN duration_minutes IS NOT NULL THEN duration_minutes / 60.0
        ELSE {{default_shift_hours}}
      END AS shift_hours_raw
    FROM employee_shifts
    WHERE employee_id IS NOT NULL OR _meta_employee_id IS NOT NULL
  ),
  
  -- Step 2: Calculate shift hours from times if not available
  shifts_with_hours AS (
    SELECT 
      *,
      CASE 
        WHEN shift_hours_raw != {{default_shift_hours}} THEN shift_hours_raw
        WHEN shift_start_parsed IS NOT NULL AND shift_end_parsed IS NOT NULL THEN
          CASE 
            WHEN shift_end_parsed > shift_start_parsed THEN
              (EXTRACT(HOUR FROM shift_end_parsed) * 60 + EXTRACT(MINUTE FROM shift_end_parsed)
               - EXTRACT(HOUR FROM shift_start_parsed) * 60 - EXTRACT(MINUTE FROM shift_start_parsed)) / 60.0
            ELSE  -- Handle overnight shifts
              (24 * 60 + EXTRACT(HOUR FROM shift_end_parsed) * 60 + EXTRACT(MINUTE FROM shift_end_parsed)
               - EXTRACT(HOUR FROM shift_start_parsed) * 60 - EXTRACT(MINUTE FROM shift_start_parsed)) / 60.0
          END
        ELSE {{default_shift_hours}}
      END AS shift_hours,
      -- Detect shift type based on start hour
      CASE 
        WHEN shift_start_parsed IS NOT NULL THEN
          CASE 
            WHEN EXTRACT(HOUR FROM shift_start_parsed) >= 5 AND EXTRACT(HOUR FROM shift_start_parsed) < 12 THEN 'MORNING'
            WHEN EXTRACT(HOUR FROM shift_start_parsed) >= 12 AND EXTRACT(HOUR FROM shift_start_parsed) < 14 THEN 'MID_DAY'
            WHEN EXTRACT(HOUR FROM shift_start_parsed) >= 14 AND EXTRACT(HOUR FROM shift_start_parsed) < 17 THEN 'AFTERNOON'
            WHEN EXTRACT(HOUR FROM shift_start_parsed) >= 17 AND EXTRACT(HOUR FROM shift_start_parsed) < 21 THEN 'EVENING'
            ELSE 'NIGHT'
          END
        ELSE 'UNKNOWN'
      END AS detected_shift_type
    FROM shifts_prepared
  ),
  
  -- Step 3: Build compensation lookup (try employee_compensation first, then monthly_salary)
  compensation_lookup AS (
    SELECT 
      COALESCE(employee_id, '') AS emp_id,
      COALESCE(employee_name, '') AS emp_name,
      COALESCE(position, job_title, '') AS position,
      COALESCE(employment_type, 'salaried') AS employment_type,
      COALESCE(
        effective_hourly_cost,
        hourly_rate,
        -- Calculate from gross salary if available
        CASE 
          WHEN gross_salary IS NOT NULL AND monthly_hours IS NOT NULL AND monthly_hours > 0 
          THEN gross_salary * (1 + {{benefits_loading}}) / monthly_hours
          ELSE 0
        END
      ) AS hourly_cost
    FROM employee_compensation
    WHERE employee_id IS NOT NULL OR employee_name IS NOT NULL
  ),
  
  -- Step 4: Join shifts with compensation
  shifts_with_comp AS (
    SELECT 
      s.employee_id,
      s.employee_name,
      s.shift_date,
      s.shift_start,
      s.shift_end,
      s.shift_start_parsed,
      s.shift_end_parsed,
      s.shift_hours,
      s.detected_shift_type,
      COALESCE(c.position, '') AS position,
      COALESCE(c.employment_type, 'unknown') AS employment_type,
      COALESCE(c.hourly_cost, 0) AS hourly_cost,
      -- Calculate shift cost
      ROUND(s.shift_hours * COALESCE(c.hourly_cost, 0), 2) AS shift_cost
    FROM shifts_with_hours s
    LEFT JOIN compensation_lookup c
      ON s.employee_id = c.emp_id 
      OR s.employee_name = c.emp_name
  ),
  
  -- Step 5: Count procedures per shift (optional - requires medical_actions)
  procedure_counts AS (
    SELECT 
      s.employee_id,
      s.shift_date,
      s.shift_start_parsed,
      s.shift_end_parsed,
      COUNT(m.treatment_start_time) AS procedure_count
    FROM shifts_with_hours s
    LEFT JOIN medical_actions m
      ON CAST(s.shift_date AS DATE) = CAST(m.treatment_date AS DATE)
      AND TRY_CAST(
        TRIM(REPLACE(REPLACE(CAST(m.treatment_start_time AS VARCHAR), '*', ''), ' ', ''))
        AS TIME
      ) BETWEEN s.shift_start_parsed AND s.shift_end_parsed
    GROUP BY s.employee_id, s.shift_date, s.shift_start_parsed, s.shift_end_parsed
  ),
  
  -- Step 6: Final join with procedure counts
  final_result AS (
    SELECT 
      s.shift_date,
      s.employee_id,
      s.employee_name,
      s.position,
      s.shift_start,
      s.shift_end,
      ROUND(s.shift_hours, 2) AS shift_hours,
      ROUND(s.hourly_cost, 2) AS hourly_cost,
      s.employment_type,
      s.shift_cost,
      COALESCE(p.procedure_count, 0) AS procedure_count,
      -- Calculate average cost per procedure
      CASE 
        WHEN COALESCE(p.procedure_count, 0) > 0 
        THEN ROUND(s.shift_cost / p.procedure_count, 2)
        ELSE NULL
      END AS avg_cost_per_procedure,
      s.detected_shift_type,
      -- Build evidence string
      '[' || s.detected_shift_type || ' SHIFT] ' ||
      'Shift ' || COALESCE(s.shift_start, 'N/A') || '-' || COALESCE(s.shift_end, 'N/A') || 
      ' on ' || CAST(s.shift_date AS VARCHAR) || '. ' ||
      'Duration: ' || CAST(ROUND(s.shift_hours, 1) AS VARCHAR) || 'h × $' || 
      CAST(ROUND(s.hourly_cost, 2) AS VARCHAR) || '/h = $' || 
      CAST(s.shift_cost AS VARCHAR) ||
      CASE 
        WHEN s.employment_type = 'salaried' THEN ' (rate includes 25% benefits loading)'
        WHEN s.employment_type = 'contractor' THEN ' (contractor rate)'
        ELSE ''
      END ||
      CASE 
        WHEN COALESCE(p.procedure_count, 0) > 0 THEN 
          ' Procedures: ' || CAST(p.procedure_count AS VARCHAR) || 
          '. Avg cost/procedure: $' || 
          CAST(ROUND(s.shift_cost / p.procedure_count, 2) AS VARCHAR)
        ELSE ' No procedures matched to this shift.'
      END AS evidence
    FROM shifts_with_comp s
    LEFT JOIN procedure_counts p
      ON s.employee_id = p.employee_id 
      AND s.shift_date = p.shift_date
      AND s.shift_start_parsed = p.shift_start_parsed
  )
  
  -- Final output sorted by shift type then date
  SELECT * FROM final_result
  ORDER BY 
    CASE detected_shift_type
      WHEN 'MORNING' THEN 1 
      WHEN 'MID_DAY' THEN 2 
      WHEN 'AFTERNOON' THEN 3 
      WHEN 'EVENING' THEN 4 
      WHEN 'NIGHT' THEN 5 
      ELSE 6 
    END,
    shift_date,
    shift_start

