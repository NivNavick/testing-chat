# Insight: Lateness and Early Arrival Flagging
# Flags employees who arrived late or more than 30 mins early

name: lateness_flags
version: "1.0"
description: "Flag employees against standards: arrival timing and lateness detection"
category: compliance
tags:
  - lateness
  - attendance
  - punctuality
  - compliance

requires:
  - employee_shifts

parameters:
  - name: start_date
    type: date
    required: false
    description: "Filter from this date"
  - name: end_date
    type: date
    required: false
    description: "Filter until this date"
  - name: early_threshold_minutes
    type: integer
    required: false
    default: 30
    description: "Maximum acceptable early arrival (default: 30 minutes)"
  - name: late_threshold_minutes
    type: integer
    required: false
    default: 0
    description: "Maximum acceptable lateness (default: 0 = any lateness is flagged)"
  - name: department
    type: string
    required: false
    description: "Filter by department"

sql: |
  WITH attendance_analysis AS (
    SELECT 
      employee_id,
      employee_name,
      shift_date,
      department_code,
      shift_type,
      shift_start,
      shift_end,
      actual_start,
      actual_end,
      -- Parse times and calculate arrival difference in minutes
      -- Positive = late, Negative = early
      (
        (CAST(SUBSTR(actual_start, 1, 2) AS INTEGER) * 60 + CAST(SUBSTR(actual_start, 4, 2) AS INTEGER))
        - (CAST(SUBSTR(shift_start, 1, 2) AS INTEGER) * 60 + CAST(SUBSTR(shift_start, 4, 2) AS INTEGER))
      ) AS arrival_diff_minutes,
      -- Calculate departure difference  
      -- Positive = stayed late, Negative = left early
      (
        (CAST(SUBSTR(actual_end, 1, 2) AS INTEGER) * 60 + CAST(SUBSTR(actual_end, 4, 2) AS INTEGER))
        - (CAST(SUBSTR(shift_end, 1, 2) AS INTEGER) * 60 + CAST(SUBSTR(shift_end, 4, 2) AS INTEGER))
      ) AS departure_diff_minutes
    FROM employee_shifts
    WHERE actual_start IS NOT NULL
      AND actual_start != ''
      {? AND shift_date >= '{{start_date}}' ?}
      {? AND shift_date <= '{{end_date}}' ?}
      {? AND department_code = '{{department}}' ?}
  )
  SELECT 
    employee_id,
    employee_name,
    shift_date,
    department_code,
    shift_type,
    shift_start AS scheduled_start,
    actual_start,
    shift_end AS scheduled_end,
    actual_end,
    arrival_diff_minutes,
    departure_diff_minutes,
    -- Classify arrival
    CASE 
      WHEN arrival_diff_minutes > {{late_threshold_minutes}} THEN 'LATE'
      WHEN arrival_diff_minutes < -{{early_threshold_minutes}} THEN 'TOO_EARLY'
      WHEN arrival_diff_minutes < 0 THEN 'EARLY_OK'
      ELSE 'ON_TIME'
    END AS arrival_status,
    -- Classify departure  
    CASE 
      WHEN departure_diff_minutes < -15 THEN 'LEFT_EARLY'
      WHEN departure_diff_minutes > 30 THEN 'OVERTIME'
      ELSE 'NORMAL'
    END AS departure_status,
    -- Summary compliance flag
    CASE 
      WHEN arrival_diff_minutes > {{late_threshold_minutes}} THEN 'FLAGGED_LATE'
      WHEN arrival_diff_minutes < -{{early_threshold_minutes}} THEN 'FLAGGED_TOO_EARLY'
      WHEN departure_diff_minutes < -15 THEN 'FLAGGED_EARLY_DEPARTURE'
      ELSE 'OK'
    END AS compliance_flag,
    -- Minutes late (only positive values)
    CASE 
      WHEN arrival_diff_minutes > {{late_threshold_minutes}} THEN arrival_diff_minutes
      ELSE 0
    END AS minutes_late,
    -- Minutes too early (absolute value)
    CASE 
      WHEN arrival_diff_minutes < -{{early_threshold_minutes}} THEN ABS(arrival_diff_minutes)
      ELSE 0
    END AS minutes_too_early,
    -- EVIDENCE: Explain how the finding was determined
    CASE 
      WHEN arrival_diff_minutes > {{late_threshold_minutes}} THEN 
        'Arrived at ' || actual_start || ' but shift was scheduled to start at ' || shift_start || 
        '. Difference: ' || arrival_diff_minutes || ' minutes late (threshold: ' || {{late_threshold_minutes}} || ' min)'
      WHEN arrival_diff_minutes < -{{early_threshold_minutes}} THEN 
        'Arrived at ' || actual_start || ' which is ' || ABS(arrival_diff_minutes) || 
        ' minutes before shift start at ' || shift_start || ' (max allowed early: ' || {{early_threshold_minutes}} || ' min)'
      WHEN departure_diff_minutes < -15 THEN 
        'Left at ' || actual_end || ' but shift was scheduled to end at ' || shift_end || 
        '. Left ' || ABS(departure_diff_minutes) || ' minutes early (threshold: 15 min)'
      WHEN departure_diff_minutes > 30 THEN 
        'Left at ' || actual_end || ' which is ' || departure_diff_minutes || 
        ' minutes after scheduled end at ' || shift_end || ' (overtime)'
      ELSE 
        'Arrived at ' || actual_start || ' for ' || shift_start || ' shift (' || 
        CASE WHEN arrival_diff_minutes < 0 THEN ABS(arrival_diff_minutes) || ' min early' 
             WHEN arrival_diff_minutes = 0 THEN 'on time'
             ELSE arrival_diff_minutes || ' min late but within threshold' END || 
        '). Departed at ' || actual_end || ' for ' || shift_end || ' end (' ||
        CASE WHEN departure_diff_minutes < 0 THEN ABS(departure_diff_minutes) || ' min early but OK'
             WHEN departure_diff_minutes = 0 THEN 'on time'
             ELSE departure_diff_minutes || ' min overtime but OK' END || ').'
    END AS evidence
  FROM attendance_analysis
  ORDER BY 
    -- Show flagged issues first
    CASE 
      WHEN arrival_diff_minutes > {{late_threshold_minutes}} THEN 0
      WHEN arrival_diff_minutes < -{{early_threshold_minutes}} THEN 1
      WHEN departure_diff_minutes < -15 THEN 2
      ELSE 3
    END,
    arrival_diff_minutes DESC,
    shift_date, 
    employee_id
